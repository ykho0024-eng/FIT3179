<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <title>Victim-Perpetrator Chord Diagram</title>
  <style>
    body { 
      margin: 0; 
      padding: 8px; 
      font-family: Arial, sans-serif; 
      background: white; 
    }
    .container { 
      max-width: 400px; 
      margin: 0 auto; 
      background: white; 
      padding: 10px;
    }
    h1 { 
      text-align: center; 
      color: #333; 
      margin-bottom: 5px; 
      font-size: 12px;
      font-weight: bold;
    }
    .subtitle { 
      text-align: center; 
      color: #666; 
      margin-bottom: 15px; 
      font-size: 10px; 
    }
    #vis { 
      display: flex; 
      justify-content: center;
      overflow: visible;
    }
    .ribbon {
      fill-opacity: 0.6;
      stroke-width: 1px;
      transition: fill-opacity 0.2s;
    }
    .ribbon:hover {
      fill-opacity: 0.9;
    }
    .group-arc {
      stroke: white;
      stroke-width: 1px;
    }
    .group-label {
      font-size: 7px;
      font-weight: bold;
      fill: #333;
    }
    .tooltip {
      position: absolute;
      padding: 6px 8px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 3px;
      font-size: 10px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1000;
    }
    .legend {
      text-align: center;
      margin-top: 10px;
    }
    .legend-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 10px;
    }
    .legend-items {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 1px;
    }
    .legend-text {
      font-size: 9px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Victim-Perpetrator Relationships</h1>
    <p class="subtitle">Assault Cases by Gender and Relationship</p>
    <div id="vis"></div>
    <div class="tooltip"></div>
  </div>

  <script>
    // Data setup
    const categories = [
      "Male Victims",
      "Female Victims", 
      "Stranger",
      "Family/Intimate",
      "Friend",
      "Professional/Educational",
      "Other"
    ];

    // Flow data: [source_index, target_index, value]
    const flows = [
      [0, 2, 236.2],  // Male -> Stranger
      [0, 3, 42.4],   // Male -> Family/Intimate
      [0, 4, 32.7],   // Male -> Friend
      [0, 5, 80.5],   // Male -> Professional
      [0, 6, 55.1],   // Male -> Other
      [1, 2, 131.8],  // Female -> Stranger
      [1, 3, 98.8],   // Female -> Family/Intimate
      [1, 4, 21.3],   // Female -> Friend
      [1, 5, 64.0],   // Female -> Professional
      [1, 6, 53.8]    // Female -> Other
    ];

    // Create matrix with scaling to make perpetrator categories more visible
    const matrix = Array(categories.length).fill(0).map(() => Array(categories.length).fill(0));
    
    // Calculate total for scaling
    let victimTotal = 0;
    let perpTotal = 0;
    
    flows.forEach(([source, target, value]) => {
      matrix[source][target] = value;
      victimTotal += value;
    });
    
    // Calculate perpetrator totals
    for (let i = 2; i < categories.length; i++) {
      for (let j = 0; j < 2; j++) {
        perpTotal += matrix[j][i];
      }
    }
    
    // Apply scaling factor to make perpetrator arcs more visible
    // Scale up perpetrator side by adding proportional values
    const scaleFactor = 2.5; // Increase this to make perpetrator arcs even larger
    
    flows.forEach(([source, target, value]) => {
      // Add scaled value to reverse direction to make target arcs larger
      matrix[target][source] = value * scaleFactor;
    });

    // Color scheme
    const colors = {
      "Male Victims": "#3b82f6",
      "Female Victims": "#ef4444",
      "Stranger": "#10b981",
      "Family/Intimate": "#f59e0b",
      "Friend": "#8b5cf6",
      "Professional/Educational": "#06b6d4",
      "Other": "#ec4899"
    };

    // Dimensions - smaller size
    const width = 350;
    const height = 350;
    const outerRadius = Math.min(width, height) * 0.3;
    const innerRadius = outerRadius - 15;

    // Create SVG
    const svg = d3.select("#vis")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("viewBox", `0 0 ${width} ${height}`)
      .attr("style", "max-width: 100%; height: auto;")
      .append("g")
      .attr("transform", `translate(${width / 2}, ${height / 2})`);

    // Create chord layout with custom sorting to group victims and perpetrators
    const chord = d3.chord()
      .padAngle(0.05)
      .sortSubgroups(d3.descending)
      .sortGroups((a, b) => {
        // Keep victims (0,1) on one side and perpetrators (2-6) on the other
        return a - b;
      });

    const arc = d3.arc()
      .innerRadius(innerRadius)
      .outerRadius(outerRadius);

    const ribbon = d3.ribbon()
      .radius(innerRadius);

    const chords = chord(matrix);

    // Tooltip
    const tooltip = d3.select(".tooltip");

    // Draw ribbons
    svg.append("g")
      .selectAll("path")
      .data(chords)
      .join("path")
      .attr("class", "ribbon")
      .attr("d", ribbon)
      .style("fill", d => colors[categories[d.target.index]])
      .style("stroke", d => d3.rgb(colors[categories[d.target.index]]).darker())
      .on("mouseover", function(event, d) {
        tooltip
          .style("opacity", 1)
          .html(`${categories[d.source.index]} â†’ ${categories[d.target.index]}<br/><strong>${d.source.value.toFixed(1)}k</strong> assaults`);
      })
      .on("mousemove", function(event) {
        tooltip
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 10) + "px");
      })
      .on("mouseout", function() {
        tooltip.style("opacity", 0);
      });

    // Draw groups (arcs)
    const group = svg.append("g")
      .selectAll("g")
      .data(chords.groups)
      .join("g");

    group.append("path")
      .attr("class", "group-arc")
      .attr("d", arc)
      .style("fill", d => colors[categories[d.index]])
      .on("mouseover", function(event, d) {
        tooltip
          .style("opacity", 1)
          .html(`${categories[d.index]}<br/><strong>${d.value.toFixed(1)}k</strong> total`);
      })
      .on("mousemove", function(event) {
        tooltip
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 10) + "px");
      })
      .on("mouseout", function() {
        tooltip.style("opacity", 0);
      });

    // Add labels with better positioning
    group.append("text")
      .each(d => { d.angle = (d.startAngle + d.endAngle) / 2; })
      .attr("dy", ".35em")
      .attr("class", "group-label")
      .attr("transform", d => `
        rotate(${(d.angle * 180 / Math.PI - 90)})
        translate(${outerRadius + 15})
        ${d.angle > Math.PI ? "rotate(180)" : ""}
      `)
      .style("text-anchor", d => d.angle > Math.PI ? "end" : null)
      .text(d => categories[d.index].toUpperCase());

    // Legend
    const legend = d3.select(".container")
      .append("div")
      .attr("class", "legend");

    legend.append("div")
      .attr("class", "legend-title")
      .text("Categories");

    const legendItems = legend.append("div")
      .attr("class", "legend-items");

    categories.forEach(cat => {
      const item = legendItems.append("div")
        .attr("class", "legend-item");
      
      item.append("div")
        .attr("class", "legend-color")
        .style("background-color", colors[cat]);
      
      item.append("span")
        .attr("class", "legend-text")
        .text(cat);
    });
  </script>
</body>
</html>
